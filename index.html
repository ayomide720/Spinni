<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Supa Spin Simulator</title>
<style>
  body {
    background: #f0f2f5;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    padding: 30px;
    min-height: 100vh;
    margin: 0;
    gap: 30px;
  }
  main {
    flex: 1;
    max-width: 600px;
  }
  h1 {
    margin-bottom: 10px;
  }
  button {
    padding: 12px 30px;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    background-color: #111;
    color: white;
    cursor: pointer;
    margin: 10px 10px 10px 0;
  }
/* Apply a clean modern font to the entire page */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: #333;
  background-color: #f9f9f9; /* subtle light background for contrast */
  line-height: 1.5;
  margin: 0;
  padding: 0;
}

/* Style all text inside the specific containers */
#result,
#stats,
#money,
#gears,
#luck,
#artifacts-panel { /* Added artifacts-panel */
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: #333;
  font-weight: 500;
  font-size: 16px;
  /* other styling from before */
  margin-top: 20px;
  width: 100%;
  padding: 15px 20px;
  border-radius: 12px;
  background: #fff;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  text-align: center;
  transition: box-shadow 0.3s ease;
}

/* Hover effect for containers */
#result:hover,
#stats:hover,
#money:hover,
#gears:hover,
#luck:hover,
#artifacts-panel:hover { /* Added artifacts-panel */
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

/* Money text */
#money {
  color: #27ae60;
  font-weight: 700;
  font-size: 18px;
  letter-spacing: 0.03em;
}

@import url('https://fonts.googleapis.com/css2?family=Orbitron&family=Playfair+Display&family=Uncial+Antiqua&family=Raleway&family=Great+Vibes&family=Montserrat:wght@700&display=swap');

.rarity-Common        { color: #666; }
.rarity-Uncommon      { color: #2ecc71; }
.rarity-Rare          { color: #3498db; }
.rarity-Steelbone     { color: #76798c; font-weight: bold; }
.rarity-Epic          { color: #9b59b6; }
.rarity-Legendary     { color: #f1c40f; }
.rarity-Mythic        { color: #e67e22; }
.rarity-Cracked     { color: #888; font-style: italic; }
.rarity-Chipped     { color: #999; }
.rarity-Broken      { color: #666; text-decoration: line-through; }
.rarity-Basic       { color: #aaa; }
.rarity-Dull        { color: #999; font-style: italic; }
.rarity-Tarnished   { color: #bbb; }
.rarity-Dusty       { color: #aaa; }
.rarity-Firm        { color: #666; font-weight: bold; }
.rarity-Polished    { color: #777; }
.rarity-Refined     { color: #8c8c8c; font-weight: bold; }

/* Phantom rarity */
.rarity-Phantom {
  color: slateblue;
  font-family: 'Orbitron', sans-serif;
  animation: pulseFade 2s infinite ease-in-out;
}

/* Divine rarity */
.rarity-Divine {
  color: gold;
  font-family: 'Playfair Display', serif;
  font-weight: 700;
}

/* Pulse animation */
@keyframes pulseFade {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}


/* Steelbone */
.rarity-Steelbone {
  color: #76798c;
  font-weight: bold;
  font-family: 'Orbitron', sans-serif;
  text-shadow: 0 0 8px #a3a7b0;
  animation: glowSteelbone 3s ease-in-out infinite alternate;
}
@keyframes glowSteelbone {
  0%   { text-shadow: 0 0 8px #a3a7b0; }
  100% { text-shadow: 0 0 20px #8a8fa0; }
}

/* Ancient */
.rarity-Ancient {
  color: #d35400;
  font-family: 'Uncial Antiqua', cursive;
  font-weight: 600;
  text-shadow: 0 0 8px #e67e22;
  animation: glowAncient 3.5s ease-in-out infinite alternate;
}
@keyframes glowAncient {
  0%   { text-shadow: 0 0 8px #e67e22; }
  100% { text-shadow: 0 0 18px #f39c12; }
}

/* Celestial */
.rarity-Celestial {
  color: #1abc9c;
  font-family: 'Playfair Display', serif;
  font-style: italic;
  text-shadow: 0 0 10px #16a085;
  animation: glowCelestial 2.5s ease-in-out infinite alternate;
}
@keyframes glowCelestial {
  0%   { text-shadow: 0 0 10px #16a085; }
  100% { text-shadow: 0 0 20px #1abc9c; }
}

/* Above Quantum */

.rarity-Astral {
  color: mediumorchid;
  font-family: 'Raleway', sans-serif;
  font-weight: 700;
  text-shadow: 0 0 12px #b280b2;
  animation: glowAstral 3s ease-in-out infinite alternate;
}
@keyframes glowAstral {
  0%   { text-shadow: 0 0 12px #b280b2; }
  100% { text-shadow: 0 0 24px #c49dcc; }
}

.rarity-Glitched {
  color: darkred;
  font-family: 'Montserrat', sans-serif;
  font-weight: 700;
  text-shadow: 0 0 10px #7b0000;
  animation: glowGlitched 2.5s ease-in-out infinite alternate;
}
@keyframes glowGlitched {
  0%   { text-shadow: 0 0 10px #7b0000; }
  100% { text-shadow: 0 0 22px #a00000; }
}

.rarity-Primordial {
  color: teal;
  font-weight: bold;
  font-family: 'Great Vibes', cursive;
  text-shadow: 0 0 15px #008080;
  animation: glowPrimordial 4s ease-in-out infinite alternate;
}
@keyframes glowPrimordial {
  0%   { text-shadow: 0 0 15px #008080; }
  100% { text-shadow: 0 0 30px #00a0a0; }
}

.rarity-Ethereal {
  color: #a29bfe;
  font-family: 'Raleway', sans-serif;
  font-style: italic;
  font-weight: 600;
  text-shadow: 0 0 14px #8c87ff;
  animation: glowEthereal 3.5s ease-in-out infinite alternate;
}
@keyframes glowEthereal {
  0%   { text-shadow: 0 0 14px #8c87ff; }
  100% { text-shadow: 0 0 28px #b0adff; }
}

.rarity-Reality-Bound {
  color: #8e44ad;
  font-weight: bold;
  font-family: 'Montserrat', sans-serif;
  text-shadow: 0 0 14px #5a2f71;
  animation: glowRealityBound 3s ease-in-out infinite alternate;
}
@keyframes glowRealityBound {
  0%   { text-shadow: 0 0 14px #5a2f71; }
  100% { text-shadow: 0 0 26px #8e44ad; }
}

.rarity-Genesis {
  color: #000;
  background: #fff;
  padding: 2px 6px;
  border-radius: 6px;
  font-family: 'Playfair Display', serif;
  font-weight: 700;
  text-shadow: 0 0 12px #555;
  animation: glowGenesis 4s ease-in-out infinite alternate;
}
@keyframes glowGenesis {
  0%   { text-shadow: 0 0 12px #555; }
  100% { text-shadow: 0 0 24px #888; }
}

  .variant {
    font-style: italic;
    margin-left: 5px;
    padding: 2px 6px;
    border-radius: 5px;
    background: #eee;
    font-weight: 600;
    user-select: none;
  }
  /* Variant colors by rarity */
.variant-common {
  color: #7f8c8d; /* greyish */
  font-weight: 600;
  user-select: none;
}

.variant-uncommon {
  color: #27ae60; /* green */
  font-weight: 600;
  user-select: none;
}
/* Base animation keyframes */
@keyframes pulseGlow {
  0% { box-shadow: 0 0 6px currentColor; }
  50% { box-shadow: 0 0 20px currentColor; transform: scale(1.03); }
  100% { box-shadow: 0 0 6px currentColor; }
}

@keyframes colorCycle {
  0%   { filter: hue-rotate(0deg); }
  100% { filter: hue-rotate(360deg); }
}

/* Animated Rarity Styles */

.rarity-Glitched {
  color: darkred;
  font-weight: bold;
  animation: pulseGlow 1.5s infinite;
}

.rarity-Primordial {
  color: teal;
  font-weight: bold;
  animation: pulseGlow 1.6s infinite ease-in-out;
}

.rarity-Ethereal {
  color: #a29bfe;
  font-style: italic;
  animation: colorCycle 3s linear infinite;
}

.rarity-Reality-Bound {
  color: #8e44ad;
  background: linear-gradient(45deg, #8e44ad, #d0c1f7);
  background-clip: text;
  -webkit-background-clip: text;
  color: transparent;
  animation: colorCycle 4s linear infinite;
}

.rarity-Genesis {
  color: #fff;
  background: linear-gradient(90deg, #000, #ff0, #000);
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 900;
  animation: pulseGlow 1.2s infinite, colorCycle 5s linear infinite;
}
  /* Sidebar dropdown styling */
  #sidebar {
    width: 250px;
    background: white;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
  }

  #auto-spin-rate {
  margin-top: 10px;
  font-size: 16px;
  color: #333;
}

  label {
    font-weight: 600;
    display: block;
    margin-bottom: 8px;
  }
  #upgrades-panel, #artifacts-panel { /* Added artifacts-panel */
  margin-top: 20px;
  padding: 20px;
  border-radius: 12px;
  background: white;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
.upgrade-box, .artifact-box { /* Added .artifact-box */
  margin-bottom: 15px;
  font-size: 15px;
}
#buy-luck-upgrade, .buy-artifact-btn { /* Added .buy-artifact-btn */
  margin-top: 8px;
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 6px;
  background: #27ae60;
  color: white;
  border: none;
  cursor: pointer;
}
.buy-gear-btn {
  margin-top: 8px;
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 6px;
  background: #007bff; /* Blue for gear buy button */
  color: white;
  border: none;
  cursor: pointer;
}
.buy-gear-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
}

  select {
    width: 100%;
    font-size: 16px;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-bottom: 15px;
    cursor: pointer;
  }
    #gear-panel {
  width: 300px;
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
}
#inventory-display {
  margin-top: 20px;
  padding: 15px;
  border-radius: 12px;
  background: white;
  box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
}
#rarity-counts {
  font-size: 15px;
  line-height: 1.6;
  text-align: left;
}

.gear-box {
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.gear-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 8px;
}

.gear-progress {
  height: 18px;
  background: #ddd;
  border-radius: 10px;
  overflow: hidden;
  margin: 6px 0;
}

.gear-progress-bar {
  height: 100%;
  background: linear-gradient(to right, #4caf50, #2ecc71);
  width: 0%;
  transition: width 0.3s ease;
  color: white;
  font-size: 12px;
  text-align: center;
  line-height: 18px;
}

.gear-status {
  font-size: 14px;
  margin-top: 5px;
}
/* Floating particle container */

</style>
</head>
<body>
<audio id="bgm-audio" src="ScreenRecording_07-13-2025_16-13-26_1 (1).mp3" loop></audio>
<main>
  <h1>♤ Supa Spin Game ♤</h1>
  <button id="spin-btn">Spin</button>
  <button id="auto-spin-btn" disabled>Auto Spin: OFF</button>

  <div id="result">Your result will appear here.</div>
  <div id="money"> 0</div>
  <div id="stats">Total Spins: 0<br>Rarest Pull: N/A</div>
  <div id="luck">Luck Bonus from Gears: 0%</div>
  <div id="auto-spin-rate">Auto Spin Rate: OFF</div>
  <div id="gears">
    <div id="spinBoostDisplay" style="position: fixed; top: 10px; right: 10px;
  background: rgba(0,0,0,0.6); color: white; padding: 8px 12px; border-radius: 8px;
  font-family: monospace; font-weight: bold; z-index: 1000;">
  Spin Speed Boost: 0%
</div>
    <h3>Gear Status</h3>
    <div id="gear-list">No gears collected yet.</div>
    <div class="gear-description" style="font-style: italic; color: #555; margin-bottom: 6px;">
  ${description}
</div>
    <div id="inventory-display">
      <h3>Your Rarity Inventory</h3>
      <div id="rarity-counts">Nothing pulled yet.</div>
    </div>
  </div>
</main>

<div id="sidebar">
  <input type="text" id="secretCodeInput" placeholder="Enter secret code" />
<button id="secretCodeSubmit">Submit</button>
<div id="secretCodeMessage"></div>
  <div id="upgrades-panel">
  <h3>Upgrades</h3>
  <div class="upgrade-box">
    <strong>Luck Upgrade</strong> (Level <span id="luck-upgrade-level">0</span>)<br>
    Increases base luck by 10% per level.<br>
    <button id="buy-luck-upgrade">Buy (Cost: <span id="luck-upgrade-cost">10,000</span>)</button>
    <button id="toggle-image-showcase-btn" style="margin-bottom:10px;">Show/Hide Rarity Images</button>

<div id="image-showcase" style="display:none; border: 1px solid #ccc; padding: 10px; max-width: 600px; margin-top: 10px; background: #fafafa; overflow-x: auto; white-space: nowrap;">
  </div>
  </div>
  <div id="image-showcase" style="margin-top: 40px; padding: 20px;">
  <h2>Your Collection</h2>
  <div id="rarity-image-grid" style="display: flex; flex-wrap: wrap; gap: 15px;"></div>
</div>
</div>

<div id="artifacts-panel">
  <h3>Artifacts</h3>
  <div id="artifact-list">No artifacts discovered yet.</div>
</div>

  <label for="rarity-list">All Rarities</label>
  <select id="rarity-list" size="16" readonly>
    </select>
</div>
<script>
let bgmStarted = false;
function startBGM() {
  if (!bgmStarted) {
    const audio = document.getElementById("bgm-audio");
    audio.volume = 0.3;
    audio.play().catch(err => {
      console.log("Autoplay blocked:", err);
    });
    bgmStarted = true;
  }
}
document.addEventListener("click", startBGM, { once: true });

// Create container once
const notificationContainer = document.createElement("div");
notificationContainer.style.position = "fixed";
notificationContainer.style.bottom = "20px";
notificationContainer.style.left = "50%";
notificationContainer.style.transform = "translateX(-50%)";
notificationContainer.style.display = "flex";
notificationContainer.style.flexDirection = "column-reverse";
notificationContainer.style.alignItems = "center";
notificationContainer.style.zIndex = "9999";
document.body.appendChild(notificationContainer);

const notificationTimeouts = new Map();
let fortuneRingNotified = false;

function showNotification(message, color = "#00c8ff", duration = 2500) {
  // Check if notification with same message exists
  let existing = [...notificationContainer.children].find(
    (note) => note.textContent === message
  );

  if (existing) {
    clearTimeout(notificationTimeouts.get(existing));

    const timeoutId = setTimeout(() => {
      existing.style.opacity = "0";
      existing.style.transform = "translateY(-30px)";
      setTimeout(() => {
        existing.remove();
        notificationTimeouts.delete(existing);
      }, 400);
    }, duration);

    notificationTimeouts.set(existing, timeoutId);
    return; // Don't create a new duplicate notification
  }

  // Create new notification
  const note = document.createElement("div");
  note.textContent = message;
  note.style.position = "relative";
  note.style.background = color;
  note.style.color = "#fff";
  note.style.padding = "10px 18px";
  note.style.marginTop = "10px";
  note.style.borderRadius = "10px";
  note.style.fontWeight = "bold";
  note.style.boxShadow = "0 3px 10px rgba(0,0,0,0.3)";
  note.style.fontSize = "15px";
  note.style.opacity = "0";
  note.style.transform = "translateY(-40px)";
  note.style.transition = "all 0.4s ease-out";

  notificationContainer.appendChild(note);

  requestAnimationFrame(() => {
    note.style.opacity = "1";
    note.style.transform = "translateY(0)";
  });

  const timeoutId = setTimeout(() => {
    note.style.opacity = "0";
    note.style.transform = "translateY(-30px)";
    setTimeout(() => {
      note.remove();
      notificationTimeouts.delete(note);
    }, 400);
  }, duration);

  notificationTimeouts.set(note, timeoutId);
}
// Toggle show/hide the image showcase div
document.getElementById("toggle-image-showcase-btn").addEventListener("click", () => {
  const showcase = document.getElementById("image-showcase");
  if (showcase.style.display === "none" || showcase.style.display === "") {
    updateImageShowcase();
    showcase.style.display = "block";
  } else {
    showcase.style.display = "none";
  }
});

function updateImageShowcase() {
  const container = document.getElementById("image-showcase");
  container.innerHTML = ""; // Clear previous

  for (const rarity of rarityOrder) {
    if (!inventory[rarity]) continue; // Show only owned rarities

    const raritySlug = rarity.toLowerCase().replace(/ /g, "-");
    const count = getRarityCount(rarity);

    const wrapper = document.createElement("div");
    wrapper.style = "display: inline-block; text-align: center; font-size: 12px; margin: 5px;";

    const img = document.createElement("img");
    img.src = `https://raw.githubusercontent.com/ayomide720/kysnrnggame/main/${raritySlug}.png`;
    img.alt = rarity;
    img.title = `${rarity} × ${count}`;
    img.style = "width: 64px; height: 64px; image-rendering: pixelated; display: block; margin: 0 auto;";

    const label = document.createElement("div");
    label.innerHTML = `<span class="rarity-${rarity.replace(/ /g,"-")}">${rarity}</span>`;

    img.onload = () => {
      wrapper.appendChild(img);
      wrapper.appendChild(label);
    };

    img.onerror = () => {
      // If no image, just show the label text
      wrapper.appendChild(label);
    };

    // Append wrapper immediately so at least label appears
    container.appendChild(wrapper);
  }
}

const rarityDropRates = {
  "Cracked": 1 / 25,
  "Chipped": 1 / 33,
  "Broken": 1 / 40,
  "Basic": 1 / 50,
  "Dull": 1 / 66,
  "Tarnished": 1 / 80,
  "Common": 1 / 100,
  "Dusty": 1 / 133,
  "Uncommon": 1 / 200,
  "Firm": 1 / 333,
  "Polished": 1 / 400,
  "Refined": 1 / 500,
  "Rare": 1 / 1000,
  "Steelbone": 1 / 2000,
  "Epic": 1 / 3333,
  "Legendary": 1 / 10000,
  "Mythic": 1 / 13333,
  "Ancient": 1 / 20000,
  "Celestial": 1 / 50000,
  "Transcendent": 1 / 100000,
  "Omniversal": 1 / 200000,
  "Divine": 1 / 333333,
  "Phantom": 1 / 500000,
  "Quantum": 1 / 1000000,
  "Astral": 1 / 2000000,
  "Primordial": 1 / 200000,
  "Glitched": 1 / 50000000,
  "Ethereal": 1 / 106000000,
  "Reality-Bound": 1 / 90000000,
  "Genesis": 1 / 2000000000
};

const baseRarities = {};
for (const [rarity, dropRate] of Object.entries(rarityDropRates)) {
  baseRarities[rarity] = dropRate;
}

  const variants = {
    "Common": [
      {name:"Rusty", weight: 40},
      {name:"Dusty", weight: 30},
      {name:"Basic", weight: 50},
      {name:"Worn", weight: 20},
      {name:"Scratched", weight: 10},
      {name:"Faded", weight: 35},
      {name:"Plain", weight: 45}
    ],
    "Uncommon": [
      {name:"Polished", weight: 50},
      {name:"Light-Tinted", weight: 25},
      {name:"Improved", weight: 20},
      {name:"Fine", weight: 15},
      {name:"Refined", weight: 10}
    ],
    "Rare": [
      {name:"Shiny", weight: 35},
      {name:"Steel-Plated", weight: 25},
      {name:"Neat", weight: 20},
      {name:"Glow-Edge", weight: 15},
      {name:"Sharp", weight: 10}
    ],
    "Steelbone": [
      {name:"Aegis", weight: 1}
    ],
    "Epic": [
      {name:"Crimson", weight: 30},
      {name:"Shadow-Forged", weight: 20},
      {name:"Holy", weight: 15},
      {name:"Void-Touched", weight: 10},
      {name:"Spiked", weight: 5}
    ],
    "Legendary": [
      {name:"Dragoncore", weight: 25},
      {name:"Arcane-Blade", weight: 20},
      {name:"Royal", weight: 15},
      {name:"Phoenix", weight: 10},
      {name:"Duskborne", weight: 5}
    ],
    "Mythic": [
      {name:"Ethereal", weight: 20},
      {name:"Twilightborn", weight: 15},
      {name:"Spiritforged", weight: 10},
      {name:"Hellfire", weight: 7},
      {name:"Radiant", weight: 3}
    ],
    "Ancient": [
      {name:"Relic-Bound", weight: 20},
      {name:"Time-Worn", weight: 15},
      {name:"Forgotten", weight: 10},
      {name:"Runic", weight: 8},
      {name:"Ruined", weight: 5}
    ],
    "Celestial": [
      {name:"Starforged", weight: 15},
      {name:"Void-Dancer", weight: 10},
      {name:"Cometfall", weight: 8},
      {name:"Skylit", weight: 5},
      {name:"Galaxian", weight: 3}
    ],
    "Transcendent": [
      {name:"God-Touched", weight: 12},
      {name:"Echoed Soul", weight: 8},
      {name:"Lightbane", weight: 6},
      {name:"Fate-Warped", weight: 4},
      {name:"Dimensional", weight: 2}
    ],
    "Omniversal": [
      {name:"Origin", weight: 8},
      {name:"True Form", weight: 5},
      {name:"Undefined", weight: 4},
      {name:"Nullborn", weight: 2},
      {name:"Singularity", weight: 1}
    ],
    "Divine": [
      {name:"Purelight", weight: 10},
      {name:"Heaven's Kiss", weight: 7},
      {name:"Blessed", weight: 5},
      {name:"Immortal", weight: 3},
      {name:"Sacred", weight: 1}
    ],
    "Phantom": [
      {name:"Ghostblade", weight: 10},
      {name:"Wraith-Edge", weight: 7},
      {name:"Spectral", weight: 5},
      {name:"Eclipsed", weight: 3},
      {name:"Soulshadow", weight: 1}
    ],
    "Quantum": [
      {name:"Entangled", weight: 10},
      {name:"Superposed", weight: 7},
      {name:"Uncertain", weight: 5},
      {name:"Collapsed", weight: 3},
      {name:"Photon", weight: 1}
    ],
    "Astral": [
      {name:"Starborn", weight: 10},
      {name:"Celestine", weight: 7},
      {name:"Nebula", weight: 5},
      {name:"Lunar", weight: 3},
      {name:"Solar", weight: 1}
    ],
    "Primordial": [
      {name: "Beyond Time", weight: 0.1},
    ],
    "Glitched": [
      {name:"Corrupted", weight: 10},
      {name:"Broken", weight: 7},
      {name:"Fragmented", weight: 5},
      {name:"Glitched-Out", weight: 3},
      {name:"Bugged", weight: 1}
    ]
  };

  // Gear recipes: each gear requires certain counts of rarities to unlock
  // === Gear Unlock with Money Cost ===
// Modify gearRecipes to include a cost property
const gearRecipes = {
  "Gear 1: Luck Amulet": {
    requirements: { "Common": 250, "Uncommon": 125, "Rare": 25 },
    cost: 15000,
    luckBonus: 1.25,
    spinRateBoost: 0.1
  },

  "Gear 2: Fortune Ring": {
    requirements: { "Uncommon": 250, "Rare": 100, "Epic": 10 },
    cost: 40000,
    luckBonus: 2.5,
    moneyMultiplier: 0.15
  },

  "Gear 3: Eccentric Engine": {
    requirements: { "Rare": 200, "Epic": 50, "Legendary": 5 },
    cost: 60000,
    luckBonus: 4.0,
    rarityUpgradeChance: 0.10,
    spinRateBoost: 0.12
  },

  "Gear 4: Seraphim Booster": {
    requirements: {
      "Epic": 100,
      "Legendary": 30,
      "Mythic": 10,
      "Ancient": 6,
      "Celestial": 4,
      "Transcendent": 2
    },
    cost: 75000,
    luckBonus: 7.5,
    tenthSpinMoneyMultiplier: 5,
    variantRarityMultiplier: 1.1
  },

  "Gear 5: Lightspeed Obliterator": {
    requirements: {
      "Legendary": 40,
      "Mythic": 20,
      "Ancient": 10,
      "Celestial": 6,
      "Transcendent": 4,
      "Omniversal": 2
    },
    cost: 100000,
    luckBonus: 12.5,
    thirdSpinLuckBoost: 12,
    spinRateBoost: 0.25
  },

  "Gear 6: 404 Glitcher": {
    requirements: {
      "Mythic": 30,
      "Ancient": 14,
      "Celestial": 10,
      "Transcendent": 6,
      "Omniversal": 4,
      "Divine": 2
    },
    cost: 150000,
    luckBonus: 30,
    addsGlitchedVariant: true,
    glitchMoneyBoostChance: 0.35,
    glitchMoneyMultiplierPositive: 4,
    glitchMoneyMultiplierNegative: 0.6
  },

  "Gear 7: Omnicore Reactor": {
    requirements: {
      "Ancient": 30,
      "Celestial": 15,
      "Transcendent": 10,
      "Omniversal": 6,
      "Divine": 4,
      "Phantom": 2,
      "Quantum": 2
    },
    cost: 200000,
    luckBonus: 40,
    moneyMultiplier: 0.8,
    variantLuckBoost: 0.4
  },

  "Gear 8: Eternity Processor": {
    requirements: {
      "Celestial": 25,
      "Transcendent": 16,
      "Omniversal": 10,
      "Divine": 6,
      "Phantom": 3,
      "Quantum": 3,
      "Astral": 2,
      "Primordial": 2
    },
    cost: 400000,
    spinRateBoost: 0.75,
    tenthSpinMoneyMultiplier: 8,
    variantRarityMultiplier: 1.3
  },

  "Gear 9: Genesis Drive": {
    requirements: {
      "Omniversal": 10,
      "Divine": 10,
      "Phantom": 6,
      "Quantum": 5,
      "Astral": 3,
      "Primordial": 3,
      "Glitched": 2,
      "Ethereal": 2,
      "Reality-Bound": 2
    },
    cost: 800000,
    luckBonus: 300,
    bonusLuckChance: 0.4,
    moneyMultiplier: 0.4
  },

  "Gear 10: Paradox Core": {
    requirements: {
      "Divine": 15,
      "Phantom": 15,
      "Quantum": 12,
      "Astral": 8,
      "Primordial": 6,
      "Glitched": 4,
      "Ethereal": 3,
      "Reality-Bound": 3,
      "Genesis": 1,
      "Steelbone": 5
    },
    cost: 950000,
    paradoxSpinChance: 0.04,
    glitchMoneyImmunity: true
  },

  "Gear 11: Godwave Singularity": {
    requirements: {
      "Cracked": 50000,
      "Genesis": 1,
      "Ethereal": 3,
      "Reality-Bound": 3,
      "Astral": 4,
      "Primordial": 6,
      "Glitched": 4,
      "Quantum": 4,
      "Phantom": 4,
      "Divine": 15,
      "Omniversal": 5,
      "Transcendent": 8,
      "Celestial": 500,
      "Ancient": 400,
      "Mythic": 2500,
      "Steelbone": 300
    },
    cost: 10000000,
    luckBonus: 3000,
    spinRateBoost: 0.8,
    godwaveMultiplier: 8,
    overrideSpinCap: true
  }
};

  const gearDescriptions = {
  "Gear 1: Luck Amulet": "A simple amulet that increases your luck by 125%, making rare pulls more common and speeding up your spins by 25%.",
  "Gear 2: Fortune Ring": "A mystical ring that boosts your money earned per spin by 25%, turning small wins into bigger fortunes.",
  "Gear 3: Eccentric Engine": "A finely tuned device that increases your luck by 1000% and gives a 25% chance to upgrade rarities, accelerating your progress and spinning 15% faster.",
  "Gear 4: Seraphim Booster": "Harness the power of the Seraphim to multiply your 10th spin's payout by 40x and increase variant rarity by 25%, unlocking rarer variants.",
  "Gear 5: Lightspeed Obliterator": "Unleash blinding speed to boost your spin rate by 115% and gain a 25% temporary luck surge every third spin.",
  "Gear 6: 404 Glitcher": "Embrace the unpredictable with a gear that adds 50000% luck and can randomly boost (x5) or nerf (x0.5) your money on Glitched rarity pulls.",
  "Gear 7: Omnicore Reactor": "A powerful reactor that increases money earnings by 50%, boosts luck by 200%, and accelerates spin rate by 30%, pushing you closer to ultimate rarity.",
  "Gear 8: Eternity Processor": "An advanced processor that speeds up spins by 40%, increases variant chances by 35%, and boosts rare payouts by 60%.",
  "Gear 9: Genesis Drive": "The drive that controls genesis-level power, greatly enhancing luck by 400% and money multipliers by 300% for high-tier pulls.",
  "Gear 10: Paradox Core": "A core that manipulates paradoxes to protect you from glitches and unlock rare spin bonuses, increasing luck by 500% and spin speed by 50%.",
  "Gear 11: Godwave Singularity": "The pinnacle of all gear, granting massive luck boosts of 1000%, spin speed boosts of 150%, and unparalleled money multipliers up to 10x."
};

  // Keep inventory count of rarities and variants
  let inventory = {};
  // Keep track of unlocked gears
  let unlockedGears = {};
  // Keep track of discovered artifacts
  let discoveredArtifacts = {}; // New state variable for artifacts
  // Total spins
  let totalSpins = 0;
  // Money
  let money = 0;
  // Luck from gears, starts at 0
  let currentLuck = 0;
  // Highest rarity pulled (for stats)
  let rarityOrder = Object.keys(baseRarities);
  let rarityRank = {};
  rarityOrder.forEach((r, i) => rarityRank[r] = i);
  let highestRarityPulled = null;

  // Auto-spin variables
  let autoSpinEnabled = false;
  let autoSpinInterval = null;

  // === ARTIFACT SYSTEM (REWORKED) ===
  let artifactPermanentLuck = 0; // For Reality Anchor - MOVED TO TOP
  let genesisCascadeActive = false; // For Echo of Creation
  let genesisCascadeEndTime = 0; // For Echo of Creation

  const spinBtn = document.getElementById("spin-btn");
  const autoSpinBtn = document.getElementById("auto-spin-btn");
  const resultDiv = document.getElementById("result");
  const moneyDiv = document.getElementById("money");
  const statsDiv = document.getElementById("stats");
  const luckDiv = document.getElementById("luck");
  const gearListDiv = document.getElementById("gear-list");
  const autoSpinRateDiv = document.getElementById("auto-spin-rate");
  const rarityCountsDiv = document.getElementById("rarity-counts");
  const rarityListSelect = document.getElementById("rarity-list");
  const autoSpinRareThreshold = rarityRank["Reality-Bound"];

// === WEATHER SYSTEM ===

let currentWeather = null;

const weatherTypes = {
  "Mystic Storm": {
    duration: 60000,
    chance: 0.01,
    effectDescription: "Celestial is 90% more likely. Mystic variants are unlocked.",
    rarityBoost: { "Celestial": 0.90 },
    unlockVariants: ["Mystic"]
  },
  "Solar Flare": {
    duration: 45000,
    chance: 0.0075,
    effectDescription: "Ancient and Mythic increased. Unlocks Solar variants.",
    rarityBoost: { "Ancient": 0.9, "Mythic": 0.9 },
    unlockVariants: ["Solar"]
  },
  "Void Eclipse": {
    duration: 70000,
    chance: 0.0037,
    effectDescription: "Increased Glitched drop chance. Unlocks Void variants.",
    rarityBoost: { "Glitched": 120 },
    unlockVariants: ["Void"]
  },
  "Lucky Winds": {
    duration: 20000,
    chance: 0.015,
    effectDescription: "+500% global luck bonus.",
    globalLuckBoost: 5.0,
    unlockVariants: ["Windblessed"]
  }
};

// === WEATHER BANNER SETUP ===
const weatherBanner = document.createElement("div");
weatherBanner.style.position = "fixed";
weatherBanner.style.top = "10px";
weatherBanner.style.left = "50%";
weatherBanner.style.transform = "translateX(-50%)";
weatherBanner.style.padding = "8px 14px";
weatherBanner.style.borderRadius = "10px";
weatherBanner.style.background = "#222";
weatherBanner.style.color = "#fff";
weatherBanner.style.fontWeight = "bold";
weatherBanner.style.zIndex = "9999";
weatherBanner.style.fontSize = "14px";
weatherBanner.style.textAlign = "center";
document.body.appendChild(weatherBanner);

function updateWeatherBanner() {
  if (currentWeather) {
    weatherBanner.textContent = `🌩️ ${currentWeather.name} Active - ${currentWeather.effectDescription}`;
  } else {
    weatherBanner.textContent = "☀️ No weather active";
  }
}

// === WEATHER LOGIC ===
function applyWeather(name) {
  const data = weatherTypes[name];
  if (!data) return;

  currentWeather = {
    name,
    ...data
  };
  updateWeatherBanner();

  setTimeout(() => {
    clearWeather();
  }, data.duration);
}

function clearWeather() {
  currentWeather = null;
  updateWeatherBanner();
}

// === WEATHER CHECK LOOP (Every 1s) ===
setInterval(() => {
  if (!currentWeather) {
    for (const [weatherName, weatherData] of Object.entries(weatherTypes)) {
      if (Math.random() < weatherData.chance) {
        applyWeather(weatherName);
        break; // only one weather at a time
      }
    }
  }
}, 1000);

// === Initialize Weather UI on Page Load ===
updateWeatherBanner();
  // === Luck Upgrade System ===
let luckUpgradeLevel = 0;
let luckUpgradeBaseCost = 200;

function getLuckUpgradeCost() {
  return Math.floor(luckUpgradeBaseCost * Math.pow(1.75, luckUpgradeLevel));
}

function getLuckBonusFromUpgrade() {
  return luckUpgradeLevel * 0.1; // Each level = +10% luck
}

function updateLuckUpgradeUI() {
  document.getElementById("luck-upgrade-level").textContent = luckUpgradeLevel;
  document.getElementById("luck-upgrade-cost").textContent = getLuckUpgradeCost().toLocaleString();
}

// Buy Luck Upgrade logic
document.getElementById("buy-luck-upgrade").addEventListener("click", () => {
  const cost = getLuckUpgradeCost();
  if (money >= cost) {
    money -= cost;
    luckUpgradeLevel++;
    updateLuckUpgradeUI();
    moneyDiv.textContent = `Money: ${money}`;
    saveGame();
    checkGearsUnlock();
  }
});

  // Helper: Format chance from weight
function formatChance(weight) {
  const totalWeight = Object.values(baseRarities).reduce((a,b) => a + b, 0);
  if (weight === 0) return "N/A";
  const chance = weight / totalWeight;
  const inv = Math.round(1 / chance);
  return `1/${inv.toLocaleString()}`;
}

// Helper to get chance denominator string "1/XYZ"
function getChanceDenominator(rarity) {
  const weight = baseRarities[rarity];
  if (!weight) return "?";
  const totalWeight = Object.values(baseRarities).reduce((a,b) => a + b, 0); // Recalculate totalBaseWeight
  const chance = weight / totalWeight;
  return Math.round(1 / chance).toLocaleString(); // Adds commas for large numbers
}


// Initialize rarity list in sidebar with ??? for not pulled rarities
function initRarityList() {
  rarityListSelect.innerHTML = "";
  for (const rarity of rarityOrder) {
    const option = document.createElement("option");
    const pulledCount = getRarityCount(rarity);
    if (pulledCount === 0) {
      // Not pulled yet — show ??? and chance
      option.textContent = `??? - 1/${getChanceDenominator(rarity)}`;
      option.className = "rarity-" + rarity.replace(/ /g,"-");
      option.style.fontStyle = "italic";
      option.style.color = "#999";
    } else {
      // Pulled — show rarity name normally
      option.textContent = rarity;
      option.className = "rarity-" + rarity.replace(/ /g,"-");
      option.style.fontStyle = "";
      option.style.color = "";
    }
    rarityListSelect.appendChild(option);
  }
}

// Then, inside your spin() function, add this line near the end to refresh sidebar after each spin:
// initRarityList(); // This is called in updateSpinResultUI

function saveGame() {
  const data = {
    luckUpgradeLevel: luckUpgradeLevel,
    inventory: inventory,
    unlockedGears: unlockedGears,
    discoveredArtifacts: discoveredArtifacts,
    totalSpins: totalSpins,
    money: money,
    highestRarityPulled: highestRarityPulled,
    artifactPermanentLuck: artifactPermanentLuck,
    genesisCascadeActive: genesisCascadeActive,
    genesisCascadeEndTime: genesisCascadeEndTime
  };
  localStorage.setItem("supaSpinSave", JSON.stringify(data));
}

function loadGame() {
  const saved = localStorage.getItem("supaSpinSave");
  if (saved) {
    const data = JSON.parse(saved);
    luckUpgradeLevel = data.luckUpgradeLevel || 0;
    inventory = data.inventory || {};
    unlockedGears = data.unlockedGears || {};
    discoveredArtifacts = data.discoveredArtifacts || {}; // Load artifacts
    totalSpins = data.totalSpins || 0;
    money = data.money || 0;
    highestRarityPulled = data.highestRarityPulled || null;
    // Load artifact-specific states
    artifactPermanentLuck = data.artifactPermanentLuck || 0;
    genesisCascadeActive = data.genesisCascadeActive || false;
    genesisCascadeEndTime = data.genesisCascadeEndTime || 0;
    if (genesisCascadeActive && Date.now() > genesisCascadeEndTime) {
        genesisCascadeActive = false; // End cascade if expired
    }
  }
}

// Load first
loadGame();

function weightedRandomRarity(extraLuck = 0) {
  let totalLuck = currentLuck + getLuckBonusFromUpgrade() + artifactPermanentLuck + (extraLuck / 100); // Added artifact permanent luck
  const luckMultiplier = 1 + totalLuck;

  let weightedEntries = [];
  let totalWeight = 0;

  for (const [rarity, baseWeight] of Object.entries(baseRarities)) {
    let weight = baseWeight;

    // Apply luck multiplier to rarities above Legendary only
    if (rarityRank[rarity] >= rarityRank["Legendary"]) {
      weight = baseWeight * luckMultiplier;
    }

    // Apply weather rarity boost
    if (window.currentWeather && window.currentWeather.rarityBoost && window.currentWeather.rarityBoost[rarity]) {
      weight *= (1 + window.currentWeather.rarityBoost[rarity]);
    }


    weightedEntries.push({ rarity, weight });
    totalWeight += weight;
  }

  let randomWeight = Math.random() * totalWeight;
  for (const entry of weightedEntries) {
    if (randomWeight < entry.weight) return entry.rarity;
    randomWeight -= entry.weight;
  }

  return "Common";
  }

  // Weighted random helper for variants within rarity
  function weightedRandomVariant(rarity) {
  let variantList = variants[rarity];
  if (!variantList) return null;

  // Clone the variantList to avoid modifying original
  let combinedVariants = variantList.slice();

  // Add weather unlock variants if active and relevant
  if (window.currentWeather?.unlockVariants) {
    for (const weatherVariantName of window.currentWeather.unlockVariants) {
      // Check if this variant is already in the list to avoid duplicates
      if (!combinedVariants.some(v => v.name === weatherVariantName)) {
        combinedVariants.push({ name: weatherVariantName, weight: 1 }); // weight can be adjusted
      }
    }
  }

  // Calculate total weight
  let totalWeight = combinedVariants.reduce((acc, v) => acc + v.weight, 0);
  let rnd = Math.random() * totalWeight;

  for (const variant of combinedVariants) {
    if (rnd < variant.weight) return variant.name;
    rnd -= variant.weight;
  }

  return combinedVariants[0].name;
  }
  // Update inventory counts
  function addToInventory(rarity, variant) {
  if (!variant) variant = "Default"; // fallback variant name
  if (!inventory[rarity]) inventory[rarity] = {};
  if (!inventory[rarity][variant]) inventory[rarity][variant] = 0;
  inventory[rarity][variant]++;
}



  // Calculate total count of a rarity (all variants)
  function getRarityCount(rarity) {
    if (!inventory[rarity]) return 0;
    return Object.values(inventory[rarity]).reduce((a,b) => a+b, 0);
  }

  // Update the rarity counts display
function getRaritySpan(rarity) {
  const specialRarities = ["Steelbone", "Celestial", "Ancient"];
  if (specialRarities.includes(rarity)) {
    return `<span class="floating-particles rarity-${rarity.replace(/ /g, "-")}">${rarity}</span>`;
  } else {
    return `<span class="rarity-${rarity.replace(/ /g, "-")}">${rarity}</span>`;
  }
}

function updateInventoryDisplay() {
  const rarityCountsDiv = document.getElementById("rarity-counts");
  rarityCountsDiv.innerHTML = ""; // Clear existing content to rebuild the display

  // Loop through all rarities in their defined order
  for (const rarity of rarityOrder) {
    const count = getRarityCount(rarity); // Get the current total count for this rarity

    // Determine if this rarity has EVER been pulled before
    // We'll use the 'inventory' object itself for simplicity,
    // assuming if inventory[rarity] exists, it means it's been pulled at some point.
    // This is more robust than checking Object.keys().length if variants can be fully consumed.
    const hasEverPulled = inventory.hasOwnProperty(rarity);

    const rarityId = `rarity-display-${rarity.replace(/ /g, "-")}`;
    const variantId = `${rarityId}-variants`;

    // If the rarity has been pulled at least once, display its details
    if (hasEverPulled) {
      const rarityDiv = document.createElement("div");
      rarityDiv.id = rarityId;
      // Apply the correct CSS class for rarity coloring
      rarityDiv.className = `rarity-${rarity.replace(/ /g, "-")}`;
      rarityDiv.style.cursor = "pointer"; // Make it look clickable
      rarityDiv.style.fontWeight = "bold";

      // Display the rarity name and its current count.
      // The getRaritySpan function applies special styling for some rarities.
      rarityDiv.innerHTML = `▶ <strong>${getRaritySpan(rarity)}</strong>: <span class="rarity-count">${count}</span>`;

      // Add click listener to toggle the display of its variants
      rarityDiv.addEventListener("click", () => {
        const variantDiv = document.getElementById(variantId);
        if (variantDiv) {
          const isVisible = variantDiv.style.display === "block";
          variantDiv.style.display = isVisible ? "none" : "block"; // Toggle visibility
          rarityDiv.innerHTML = `<strong>${isVisible ? '▶' : '▼'} ${getRaritySpan(rarity)}</strong>: <span class="rarity-count">${count}</span>`; // Update arrow
        }
      });

      const variantDiv = document.createElement("div");
      variantDiv.id = variantId;
      variantDiv.style.display = "none"; // Variants are hidden by default
      variantDiv.style.paddingLeft = "15px";
      variantDiv.style.fontSize = "14px";
      // Get and display the breakdown of specific variants for this rarity
      variantDiv.innerHTML = getVariantBreakdown(rarity);

      rarityCountsDiv.appendChild(rarityDiv);    // Add the rarity title
      rarityCountsDiv.appendChild(variantDiv);   // Add the hidden variants container
    } else {
      // If the rarity has NOT been pulled yet, display "???" and its chance
      const denom = getChanceDenominator(rarity);
      const unknownDiv = document.createElement("div");
      unknownDiv.id = rarityId; // Still give it an ID for consistency
      unknownDiv.className = "rarity-unknown"; // A class for un-pulled rarities
      unknownDiv.style.fontStyle = "italic";
      unknownDiv.style.color = "#999"; // Greyed out for unknown rarities
      unknownDiv.textContent = `??? - 1/${denom}`; // Show "???" and its chance
      rarityCountsDiv.appendChild(unknownDiv);
    }
  }
  }



function getVariantBreakdown(rarity) {
  if (!inventory[rarity]) return "None";
  let breakdown = "";
  // Determine variant color class based on rarity
  let variantClass = "";
  if (rarity === "Common") variantClass = "variant-common";
  else if (rarity === "Uncommon") variantClass = "variant-uncommon";
  else variantClass = "variant"; // default styling for others

  for (const [variant, count] of Object.entries(inventory[rarity])) {
    breakdown += `<div class="${variantClass}">${variant}: ${count}</div>`;
  }
  return breakdown;
}


function checkRequirements(requirements) {
  for (const [rarity, needed] of Object.entries(requirements)) {
    if (getRarityCount(rarity) < needed) {
      return false;
    }
  }
  return true;
}

function checkGearsUnlock() {
  currentLuck = 0; // Reset current luck for gear calculations

  let totalGearLuck = 0;
  let unlockedCount = 0;

  for (const [gearName, gearData] of Object.entries(gearRecipes)) {
    if (unlockedGears[gearName]) {
      unlockedCount++;
      totalGearLuck += gearData.luckBonus || 0;
    }
  }

  // Add permanent luck upgrade to currentLuck
  currentLuck = totalGearLuck + getLuckBonusFromUpgrade();

  // Update luck display to include artifact permanent luck
  luckDiv.textContent = `Luck Bonus from Gears + Artifacts: ${(currentLuck * 100 + artifactPermanentLuck * 100).toFixed(2)}%`;

  updateGearListDisplay();
  moneyDiv.textContent = `Money: ${money.toLocaleString()}`;
  autoSpinBtn.disabled = unlockedCount === 0;
  saveGame();
}

// Function to consume rarities from inventory
function consumeRarities(requirements) {
  for (const [rarity, needed] of Object.entries(requirements)) {
    let stillNeeded = needed;
    if (!inventory[rarity]) continue; // No items of this rarity to consume

    for (const variant in inventory[rarity]) {
      if (stillNeeded <= 0) break;

      const available = inventory[rarity][variant];
      const toRemove = Math.min(available, stillNeeded);

      inventory[rarity][variant] -= toRemove;
      stillNeeded -= toRemove;

      if (inventory[rarity][variant] <= 0) {
        delete inventory[rarity][variant];
      }
    }
    if (Object.keys(inventory[rarity]).length === 0) {
      delete inventory[rarity]; // Remove rarity entry if no variants left
    }
  }
}

  // Count how many gears unlocked
  function unlockedGearsCount() {
    return Object.values(unlockedGears).filter(Boolean).length;
  }

  // Update gear list display with clickable gear names to show/hide requirements
// Track which gear's recipe is currently open
let openedGearName = null;

function updateGearListDisplay() {
  let html = "";

  for (const [gearName, gearData] of Object.entries(gearRecipes)) {
    const isUnlocked = unlockedGears[gearName];
    const hasRequirements = checkRequirements(gearData.requirements);
    const canAfford = money >= gearData.cost;
    const description = gearDescriptions[gearName] || "No description available.";

    // Count current requirements progress
    let totalReq = 0;
    let currentCount = 0;
    let reqListHtml = "";

    for (const [reqRarity, reqCount] of Object.entries(gearData.requirements)) {
      totalReq += reqCount;
      const playerCount = getRarityCount(reqRarity);
      currentCount += Math.min(playerCount, reqCount);
      const color = playerCount >= reqCount ? "green" : "red";
      reqListHtml += `<div style="color:${color}">${reqCount} x ${reqRarity} (You have: ${playerCount})</div>`;
    }

    const costColor = canAfford ? "green" : "red";
    reqListHtml += `<div>Cost: <span style="color:${costColor}">${gearData.cost.toLocaleString()} M</span></div>`;

    // Calculate progress percent
    const progress = totalReq > 0 ? (currentCount / totalReq) * 100 : 100;

    let buttonHtml = "";
    if (!isUnlocked) {
      if (hasRequirements && canAfford) {
        buttonHtml = `<button class="buy-gear-btn" data-gear="${gearName}">Buy</button>`;
      } else {
        buttonHtml = `<button disabled>Cannot Buy</button>`;
      }
    }

    html += `
      <div class="gear-box" style="border:1px solid #888; margin-bottom:8px; padding:8px; border-radius:5px;">
        <div class="gear-title" style="cursor:pointer; user-select:none; font-weight:bold;" data-gear="${gearName}">
          ${gearName} ${isUnlocked ? "✅" : "❌"}
        </div>

        <div class="gear-description" style="font-style: italic; color: #555; margin-bottom: 6px;">
          ${description}
        </div>

        <div class="gear-progress" style="background:#ddd; height:10px; border-radius:5px; margin:4px 0;">
          <div class="gear-progress-bar" style="background:#4caf50; height:100%; width: ${progress}%; border-radius:5px;"></div>
        </div>
        <div class="gear-status" style="font-size:14px; margin-bottom:4px;">
          ${isUnlocked ? `Unlocked! Luck +${(gearData.luckBonus*100).toFixed(1)}%` : `Progress: ${currentCount} / ${totalReq}`}
        </div>
        <div class="gear-requirements" style="display:none; padding-left:12px; font-size:13px; color:#333;">
          <strong>Requirements:</strong>
          ${reqListHtml}
        </div>
        ${buttonHtml}
      </div>
    `;
  }

  gearListDiv.innerHTML = html || "No gears collected yet.";

  // Add click listeners to toggle requirement display
  document.querySelectorAll(".gear-title").forEach(titleEl => {
    titleEl.addEventListener("click", (event) => {
      event.stopPropagation();
      const gear = titleEl.dataset.gear;
      const box = titleEl.parentElement;
      const reqDiv = box.querySelector(".gear-requirements");

      if (reqDiv.style.display === "none") {
        // Close all others first
        document.querySelectorAll(".gear-requirements").forEach(div => {
          div.style.display = "none";
        });
        reqDiv.style.display = "block";
        openedGearName = gear;
      } else {
        reqDiv.style.display = "none";
        openedGearName = null;
      }
    });
  });

  // Add event listeners for new buy gear buttons
  document.querySelectorAll(".buy-gear-btn").forEach(button => {
    button.addEventListener("click", (event) => {
      const gearName = event.target.dataset.gear;
      const gearData = gearRecipes[gearName];

      if (gearData && checkRequirements(gearData.requirements) && money >= gearData.cost) {
        money -= gearData.cost;
        consumeRarities(gearData.requirements); // Consume the rarities
        unlockedGears[gearName] = true;
        showNotification(`⚙️ Gear Unlocked: ${gearName}!`, "#007bff");
        saveGame();
        updateMoneyDisplay();
        updateGearListDisplay(); // Re-evaluate and update gear display
        updateInventoryDisplay(); // Update inventory since rarities were consumed
        checkGearsUnlock(); // Re-evaluate total bonuses
      }
    });
  });


  // Restore open gear requirements after UI rebuild
  if (openedGearName) {
    const openReqDiv = document.querySelector(`.gear-title[data-gear="${openedGearName}"]`)?.parentElement.querySelector(".gear-requirements");
    if (openReqDiv) openReqDiv.style.display = "block";
  }
}
// Clicking outside closes all open requirements
document.body.addEventListener("click", () => {
  document.querySelectorAll(".gear-requirements").forEach(reqDiv => {
    reqDiv.style.display = "none";
  });
  openedGearName = null;
});

// Enable auto-spin button from start
autoSpinBtn.disabled = false;

  // Spin function
  function spin() {
  // Money earned mapping
  const moneyMap = {
    "Cracked": 0.1, "Chipped": 0.25, "Broken": 0.5, "Basic": 0.75, "Dull": 0.9,
    "Tarnished": 1, "Common": 1.25, "Dusty": 1.5, "Uncommon": 3, "Firm": 4,
    "Polished": 5, "Refined": 6, "Rare": 7, "Steelbone": 9, "Epic": 12,
    "Legendary": 25, "Mythic": 40, "Ancient": 60, "Celestial": 100,
    "Transcendent": 200, "Omniversal": 350, "Divine": 500, "Phantom": 650,
    "Quantum": 800, "Astral": 1000, "Primordial": 1250, "Glitched": 1500,
    "Ethereal": 2000, "Reality-Bound": 5000, "Genesis": 10000
  };

  let rarity = weightedRandomRarity();
  let variant = weightedRandomVariant(rarity);
  let earned = (moneyMap[rarity] || 1);

  // Check for Genesis Cascade before anything else, overrides normal spin
  if (genesisCascadeActive && Date.now() < genesisCascadeEndTime) {
      let forcedRarity = "Genesis";
      let nextGenesisIndex = rarityRank[forcedRarity];
      if (nextGenesisIndex < rarityOrder.length - 1) { // If Genesis isn't the absolute highest
          const higherRarities = rarityOrder.slice(nextGenesisIndex);
          // Pick a random rarity from Genesis onwards, weighted towards higher tiers
          let totalHigherWeight = higherRarities.reduce((sum, r) => sum + (baseRarities[r] * 5), 0); // Boost higher rarities during cascade
          let randomHigherWeight = Math.random() * totalHigherWeight;
          for (const r of higherRarities) {
              if (randomHigherWeight < (baseRarities[r] * 5)) { // Apply same boost for selection
                  forcedRarity = r;
                  break;
              }
              randomHigherWeight -= (baseRarities[r] * 5);
          }
      }
      rarity = forcedRarity;
      variant = weightedRandomVariant(rarity);
      earned = moneyMap[rarity] || 1; // Recalculate earned based on new rarity
  }


  totalSpins++;


    // Orb of Foresight: Reroll chance
    if (discoveredArtifacts["Orb of Foresight"] && rarityRank[rarity] < rarityRank["Rare"] && Math.random() < 0.15) { // 15% chance to reroll if below Rare
        showNotification(`🔮 Orb of Foresight: Rerolling ${rarity}!`, "#673ab7");
        rarity = weightedRandomRarity(); // Reroll
        variant = weightedRandomVariant(rarity); // Get new variant
        earned = moneyMap[rarity] || 1; // Recalculate earned
    }

    // Amulet of Abundance: Duplicate money
    if (discoveredArtifacts["Amulet of Abundance"] && Math.random() < 0.10) { // 10% chance to duplicate money
        money += earned; // Add money again
        showNotification(`💎 Amulet of Abundance: Money Duplicated!`, "#ff9800");
    }

    // Chronos Shard: Extra spin
    if (discoveredArtifacts["Chronos Shard"] && Math.random() < 0.05) { // 5% chance for an extra spin
        setTimeout(() => {
            showNotification(`⏳ Chronos Shard: Extra Spin!`, "#00bcd4");
            spin(); // Trigger another spin immediately
        }, 100); // Small delay to show notification first
    }

    // Reality Anchor: Permanent stacking luck (applied in checkGearsUnlock)
    if (discoveredArtifacts["Reality Anchor"] && totalSpins % 100 === 0) {
        artifactPermanentLuck += 0.01; // +1% permanent luck every 100 spins
        showNotification(`⚓ Reality Anchor: Luck increased to +${(artifactPermanentLuck * 100).toFixed(0)}%!`, "#2196f3");
        checkGearsUnlock(); // Update luck display
    }

  let bonusLuck = 0;
// Lightspeed Obliterator (every 3rd spin = temporary luck boost)
if (unlockedGears["Gear 5: Lightspeed Obliterator"] && totalSpins % 3 === 0) {
  bonusLuck += gearRecipes["Gear 5: Lightspeed Obliterator"].thirdSpinLuckBoost || 0;
  showNotification(`⚡ Lightspeed Bonus: +${(gearRecipes["Gear 5: Lightspeed Obliterator"].thirdSpinLuckBoost * 100).toFixed(0)}% Luck!`, "#00bcd4");
}

  // 404 Glitcher (random money boost or nerf on Glitched rarity)
  if (unlockedGears["Gear 6: 404 Glitcher"] && rarity === "Glitched") {
    const gearData = gearRecipes["Gear 6: 404 Glitcher"];
    if (Math.random() < (gearData.glitchMoneyBoostChance || 0)) {
        const positive = Math.random() < 0.65; // 50/50 chance for buff or nerf
        if (!positive && discoveredArtifacts["Reality Anchor"]) { // If it would have been negative, but immunity is active
            showNotification(`🛡️ Reality Anchor: Glitch avoided!`, "#2196f3");
        } else if (positive) {
            earned *= gearData.glitchMoneyMultiplierPositive || 1;
            showNotification(`🟪 404 Glitcher Bonus x${gearData.glitchMoneyMultiplierPositive}!`, "#9c27b0");
        } else { // It's negative, and no immunity
            earned *= gearData.glitchMoneyMultiplierNegative || 1;
            showNotification(`⚠️ 404 Glitcher Glitch: x${(gearData.glitchMoneyMultiplierNegative).toFixed(2)}`, "#ff5252");
        }
    }
  }


// Existing gears you already have...

// Gear 7: Omnicore Reactor
if (unlockedGears["Gear 7: Omnicore Reactor"]) {
  const mult = gearRecipes["Gear 7: Omnicore Reactor"].moneyMultiplier || 0;
  earned *= (1 + mult);
  showNotification(`🔆 Omnicore Reactor +${(mult * 100).toFixed(0)}% Money!`, "#ffa726");
}

// Gear 8: Eternity Processor (10th spin multiplier)
if (unlockedGears["Gear 8: Eternity Processor"] && totalSpins % 10 === 0) {
  const mult = gearRecipes["Gear 8: Eternity Processor"].tenthSpinMoneyMultiplier || 1;
  earned *= mult;
  showNotification(`♾️ Eternity Boost x${mult}!`, "#5c6bc0");
}

// Gear 9: Genesis Drive (random luck boost)
if (unlockedGears["Gear 9: Genesis Drive"] && Math.random() < (gearRecipes["Gear 9: Genesis Drive"].bonusLuckChance || 0)) {
  bonusLuck += 10.0; // +100% luck temporarily
  showNotification("🌌 Genesis Surge: +1000% Luck!", "#673ab7");
}

// Gear 10: Paradox Core (5% chance to duplicate earned money)
if (unlockedGears["Gear 10: Paradox Core"] && Math.random() < (gearRecipes["Gear 10: Paradox Core"].paradoxSpinChance || 0)) {
  money += earned; // duplicate money gain
  showNotification("🌀 Paradox Echo: Spin Duplicated!", "#00acc1");
}

// Gear 11: Godwave Singularity (every 50th spin x10 money)
if (unlockedGears["Gear 11: Godwave Singularity"] && totalSpins % 50 === 0) {
  const mult = gearRecipes["Gear 11: Godwave Singularity"].godwaveMultiplier || 1;
  earned *= mult;
  showNotification(`🌠 Godwave Blast: x${mult} Money!`, "#ffeb3b");
}

  // Echo of Creation: Genesis Cascade
  if (discoveredArtifacts["Echo of Creation"] && Math.random() < 0.00001) { // 0.5% chance
      genesisCascadeActive = true;
      genesisCascadeEndTime = Date.now() + (10 * 1000); // 30 seconds duration
      showNotification(`✨ Genesis Cascade Active for 10s! All pulls are Genesis or higher!`, "#FFD700", 5000);
  }

  processSpinResult(rarity, variant, earned);
  saveGame();
}

function processSpinResult(rarity, variant, earned) {
  money += earned;

  // Auto-spin interruption logic
  if (autoSpinEnabled && rarityRank[rarity] >= autoSpinRareThreshold) {
    clearInterval(autoSpinInterval);
    autoSpinInterval = null;
    autoSpinEnabled = false;
    autoSpinBtn.textContent = "Auto Spin: (Rare pull!)";
    spinBtn.disabled = false;

    // Optional: Play rare pull sound here
    // new Audio("your-raresound.mp3").play();

    setTimeout(() => {
      // Re-enable auto spin if not manually stopped
      if (!autoSpinEnabled) { // Only restart if still in an auto-spin state (not manually turned off)
         startAutoSpin();
      }
    }, 3000); // Wait 3 seconds before resuming
  }

  // Add to inventory
  addToInventory(rarity, variant);

  // Update highest rarity pulled
  if (!highestRarityPulled || rarityRank[rarity] > rarityRank[highestRarityPulled]) {
    highestRarityPulled = rarity;
  }

  // Update UI
  updateSpinResultUI(rarity, variant, earned, money, totalSpins, highestRarityPulled);

  // Check if any gears can unlock now
  checkGearsUnlock();
  // Check if any artifacts can be discovered
  updateArtifactsPanelAndBonuses();
}


function updateSpinResultUI(rarity, variant, earned, money, totalSpins, highestRarityPulled) {
  resultDiv.innerHTML = `<span class="rarity-${rarity.replace(/ /g, "-")}">${rarity} (1/${getChanceDenominator(rarity)})</span> <span class="variant">${variant}</span><br>Money earned: ${earned.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
  moneyDiv.textContent = ` M ${money.toLocaleString()}`;
  statsDiv.innerHTML = `Total Spins: ${totalSpins.toLocaleString()}<br>Rarest Pull: <span class="rarity-${(highestRarityPulled || "Common").replace(/ /g, "-")}">${highestRarityPulled || "N/A"}</span>`;
  updateInventoryDisplay();
  initRarityList();
}


  spinBtn.addEventListener("click", spin);

  function startAutoSpin() {
  const baseInterval = 200; // default spin delay in ms
  let totalBoost = 0;

  for (const gearName in unlockedGears) {
    if (unlockedGears[gearName] && gearRecipes[gearName]) {
      totalBoost += gearRecipes[gearName].spinRateBoost || 0;
    }
  }

  totalBoost = Math.min(Math.max(totalBoost, 0), 0.95); // cap between 0%–95%
  const interval = Math.max(baseInterval * (1 - totalBoost), 50);

  // Update spin speed UI
  const spinBoostDiv = document.getElementById("spinBoostDisplay");
  if (spinBoostDiv) {
    spinBoostDiv.textContent = `Spin Speed Boost: ${(totalBoost * 100).toFixed(1)}%`;
  }

  clearInterval(autoSpinInterval);
  autoSpinInterval = setInterval(spin, interval);
  autoSpinEnabled = true;
  autoSpinBtn.textContent = "Auto Spin: ON";
  spinBtn.disabled = true;
  }

function stopAutoSpin(reason = "OFF") {
  clearInterval(autoSpinInterval);
  autoSpinInterval = null;
  autoSpinEnabled = false;
  autoSpinBtn.textContent = `Auto Spin: ${reason}`;
  spinBtn.disabled = false;

  const spinBoostDiv = document.getElementById("spinBoostDisplay");
  if (spinBoostDiv) {
    spinBoostDiv.textContent = `Spin Speed Boost: 0%`;
  }
}

autoSpinBtn.addEventListener("click", () => {
  if (autoSpinEnabled) stopAutoSpin("OFF");
  else startAutoSpin();
});
// Your existing setup and initialization code, e.g.:
// initRarityList();
// updateGearListDisplay();
// updateInventoryDisplay();
// etc...

// Now add secret code handler after the UI elements exist
const secretCode = "yopapa"; // Change to your private dev code

document.getElementById("secretCodeSubmit").addEventListener("click", () => {
  const input = document.getElementById("secretCodeInput").value.trim();
  const msgEl = document.getElementById("secretCodeMessage");

  if (input === secretCode) {
    // Unlock all gears
    for (const gearName of Object.keys(gearRecipes)) {
      unlockedGears[gearName] = true;
    }
    // Discover all artifacts
    for (const artifactName of Object.keys(artifactRecipes)) {
      discoveredArtifacts[artifactName] = true;
    }


    updateGearListDisplay();
    updateArtifactsPanelAndBonuses(); // Update artifacts display after unlocking all
    checkGearsUnlock(); // Recalculate bonuses
    msgEl.style.color = "green";
    msgEl.textContent = "✅ All gears and artifacts unlocked!";
  } else {
    msgEl.style.color = "red";
    msgEl.textContent = "❌ Invalid code.";
  }

  document.getElementById("secretCodeInput").value = "";
});


// === ARTIFACT SYSTEM (REWORKED) ===
const artifactRecipes = {
  "Orb of Foresight": {
    requirements: { "Epic": 50, "Rare": 200, "Uncommon": 500 },
    cost: 50000,
    description: "Grants a 15% chance to reroll your spin result if it's below 'Rare'."
  },
  "Amulet of Abundance": {
    requirements: { "Legendary": 10, "Epic": 80, "Rare": 300 },
    cost: 150000,
    description: "Provides a 10% chance to duplicate the money earned from your spin."
  },
  "Chronos Shard": {
    requirements: { "Mythic": 5, "Legendary": 20, "Ancient": 10, "Primordial": 2 },
    cost: 500000,
    description: "Grants a 5% chance for an immediate, free extra spin after your current one."
  },
  "Reality Anchor": {
    requirements: { "Reality-Bound": 1, "Ethereal": 2, "Glitched": 3 },
    cost: 5000000,
    description: "Prevents negative Glitched effects and grants +1% permanent luck every 100 spins."
  },
  "Echo of Creation": {
    requirements: { "Genesis": 1, "Primordial": 2, "Astral": 3, "Transcendent": 3},
    cost: 10000000,
    description: "Grants a 0.5% chance for a 'Genesis Cascade', forcing Genesis or higher rarity pulls for 30 seconds."
  }
};


function updateArtifactsPanelAndBonuses() { // Renamed from checkArtifactDiscovery
  const artifactListDiv = document.getElementById("artifact-list");
  let html = "";
  let anyDiscoverable = false;

  for (const [artifactName, artifactData] of Object.entries(artifactRecipes)) {
    const isDiscovered = discoveredArtifacts[artifactName];
    const hasRequirements = checkRequirements(artifactData.requirements);
    const canAfford = money >= artifactData.cost;

    let reqListHtml = "";
    for (const [reqRarity, reqCount] of Object.entries(artifactData.requirements)) {
      const playerCount = getRarityCount(reqRarity);
      const color = playerCount >= reqCount ? "green" : "red";
      reqListHtml += `<div style="color:${color}">${reqCount} x ${reqRarity} (You have: ${playerCount})</div>`;
    }
    const costColor = canAfford ? "green" : "red";
    reqListHtml += `<div>Cost: <span style="color:${costColor}">${artifactData.cost.toLocaleString()} M</span></div>`;

    let buttonHtml = "";
    if (!isDiscovered) {
      if (hasRequirements && canAfford) {
        buttonHtml = `<button class="buy-artifact-btn" data-artifact="${artifactName}">Discover</button>`;
        anyDiscoverable = true;
      } else {
        buttonHtml = `<button disabled>Cannot Discover</button>`;
      }
    }

    html += `
      <div class="artifact-box" style="border:1px solid #888; margin-bottom:8px; padding:8px; border-radius:5px;">
        <div style="font-weight:bold;">${artifactName} ${isDiscovered ? "🌟" : "❓"}</div>
        <div style="font-style: italic; color: #555; margin-bottom: 6px;">${artifactData.description}</div>
        <div style="font-size:14px;">
          ${isDiscovered ? "<strong>Discovered!</strong>" : "<strong>Requirements:</strong>" + reqListHtml}
        </div>
        ${buttonHtml}
      </div>
    `;
  }

  artifactListDiv.innerHTML = html || "No artifacts defined.";

  // Add event listeners for new discover buttons
  document.querySelectorAll(".buy-artifact-btn").forEach(button => {
    button.addEventListener("click", (event) => {
      const artifactName = event.target.dataset.artifact;
      const artifactData = artifactRecipes[artifactName];

      if (artifactData && checkRequirements(artifactData.requirements) && money >= artifactData.cost) {
        money -= artifactData.cost;
        consumeRarities(artifactData.requirements);
        discoveredArtifacts[artifactName] = true;
        showNotification(`✨ Artifact Found: ${artifactName}!`, "#ffcc00");
        saveGame();
        updateMoneyDisplay();
        updateArtifactsPanelAndBonuses(); // Re-evaluate and update artifact display
        updateInventoryDisplay(); // Update inventory since rarities were consumed
        checkGearsUnlock(); // Re-evaluate gear requirements too
      }
    });
  });

  // Update UI elements that depend on artifact bonuses
  luckDiv.textContent = `Luck Bonus from Gears + Artifacts: ${(currentLuck * 100 + artifactPermanentLuck * 100).toFixed(2)}%`;
  updateMoneyDisplay();
  updateSpinBoostDisplay();
}


function updateMoneyDisplay() {
  moneyDiv.textContent = `Money: ${money.toLocaleString()}`;
}

function updateSpinBoostDisplay() {
  let totalBoost = 0;
  for (const gearName in unlockedGears) {
    if (unlockedGears[gearName]) {
      totalBoost += gearRecipes[gearName].spinRateBoost || 0;
    }
  }

  totalBoost = Math.min(totalBoost, 250); // Cap boost

  const boostPercent = (totalBoost * 100).toFixed(1);
  const spinBoostDiv = document.getElementById("spinBoostDisplay");
  if (spinBoostDiv) {
    spinBoostDiv.textContent = `Spin Speed Boost: ${boostPercent}%`;
  }
}


  // Initial calls to update UI
  initRarityList();
  updateGearListDisplay();
  updateInventoryDisplay();
  updateLuckUpgradeUI();
  updateArtifactsPanelAndBonuses(); // Call to initialize artifacts display
  checkGearsUnlock(); // This also updates currentLuck and luckDiv
  updateMoneyDisplay();
  updateSpinBoostDisplay();
</script>
</body>
</html>
